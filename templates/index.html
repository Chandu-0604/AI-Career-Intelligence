<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>AI Career Intelligence</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

<link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>

<body>

<div class="bg-glow"></div>

<header class="topbar">
    <div class="logo">AI Career Intelligence</div>
    <div>
        <a href="/" class="nav-pill">Analyze</a>
        <a href="/history" class="nav-pill active">History</a>
    </div>
</header>

<main class="main-wrapper">

<section class="upload-card">
<form method="POST" action="/" enctype="multipart/form-data">
<input type="file" name="resume" class="form-control mb-3" required>
<textarea name="job_description" class="form-control mb-3" rows="3" placeholder="Paste job description..." required></textarea>
<button class="btn btn-gradient w-100">Analyze Resume</button>
</form>
</section>

{% if analyzed %}

<div class="grid-layout">

<!-- LEFT -->
<div class="left-col">

<div class="glass-card hero-card">

<div class="status-pill {{ decision.color }}">
{{ decision.status }}
</div>

<div class="gauge-container">
<canvas id="gaugeChart"></canvas>
<div class="gauge-score">{{ hire_score }}%</div>
<div class="gauge-label">Interview Readiness</div>
</div>

<div class="meta-info">
<div><span>Role Alignment</span><b>{{ score }}%</b></div>
<div><span>Closest Role</span><b>{{ decision.closest_role }}</b></div>
<div><span>Main Gap</span><b>{{ decision.main_gap }}</b></div>
</div>

</div>

<div class="glass-card skill-card">
<h4>Skill Coverage</h4>
<div class="skill-layout">
<div class="skill-chart">
<canvas id="skillsChart"></canvas>
</div>
<div class="skill-text">
<h6 class="match">Matched</h6>
<ul>
{% for s in matched %}
<li>{{ s }}</li>
{% endfor %}
</ul>

<h6 class="missing">Missing</h6>
<ul>
{% for s in missing %}
<li>{{ s }}</li>
{% endfor %}
</ul>
</div>
</div>
</div>

</div>

<!-- RIGHT -->
<div class="right-col">

<div class="glass-card feedback-card">
<h4>Recruiter Evaluation</h4>
<h6 class="match">Strengths</h6>
<ul id="strengths"></ul>

<h6 class="missing">Weaknesses</h6>
<ul id="weaknesses"></ul>

<h6 class="warn">Improvements</h6>
<ul id="improvements"></ul>

<h6 class="info">Projects</h6>
<ul id="projects"></ul>
</div>

<div class="glass-card tabs-card">

<ul class="tab-header">
<li class="tab-btn active" data-tab="interview">Interview</li>
<li class="tab-btn" data-tab="roadmap">Roadmap</li>
<li class="tab-btn" data-tab="summary">Summary</li>
</ul>

<div class="tab-body">
<div class="tab-content active" id="interview"></div>
<div class="tab-content" id="roadmap"></div>
<div class="tab-content" id="summary"></div>
</div>

</div>

<div class="glass-card">
<a href="/download_report/{{ analysis_id }}" class="btn btn-gradient w-100">Download Full Report</a>
</div>

</div>

</div>

{% endif %}

</main>

{% if analyzed %}
{% if analyzed %}
<script>

async function loadAI(){

    try{

        // STEP 1: FETCH AI FROM SERVER
        const res = await fetch("/api/ai-analysis/{{ analysis_id }}");
        const data = await res.json();

        if(!data.success){
            console.log("AI error:", data.error);
            return;
        }

        // STEP 2: DISPLAY RESULTS

        document.getElementById("strengths").innerHTML =
            data.strengths.map(x=>`<li>${x}</li>`).join("");

        document.getElementById("weaknesses").innerHTML =
            data.weaknesses.map(x=>`<li>${x}</li>`).join("");

        document.getElementById("improvements").innerHTML =
            data.improvements.map(x=>`<li>${x}</li>`).join("");

        document.getElementById("projects").innerHTML =
            data.projects.map(x=>`<li>${x}</li>`).join("");

        document.getElementById("interview").innerHTML =
            marked.parse(data.questions);

        document.getElementById("roadmap").innerHTML =
            marked.parse(data.roadmap);

        document.getElementById("summary").innerHTML =
            marked.parse(data.summary);

        console.log("AI loaded and saved successfully");

    }
    catch(err){
        console.log("AI load failed:", err);
    }
}

// run after page fully loads
window.addEventListener("load", ()=>{
    setTimeout(loadAI, 1200);
});


// TAB SWITCHING
document.querySelectorAll(".tab-btn").forEach(btn=>{
    btn.onclick=()=>{
        document.querySelectorAll(".tab-btn").forEach(b=>b.classList.remove("active"));
        document.querySelectorAll(".tab-content").forEach(c=>c.classList.remove("active"));
        btn.classList.add("active");
        document.getElementById(btn.dataset.tab).classList.add("active");
    };
});


// GAUGE
new Chart(gaugeChart,{
    type:"doughnut",
    data:{datasets:[{data:[{{ hire_score }},100-{{ hire_score }}],backgroundColor:["#22c55e","#1e293b"],borderWidth:0}]},
    options:{cutout:"80%",rotation:-90,circumference:180,plugins:{legend:{display:false}}}
});


// SKILL CHART
new Chart(skillsChart,{
    type:"doughnut",
    data:{labels:["Matched","Missing"],datasets:[{data:[{{ matched|length }},{{ missing|length }}],backgroundColor:["#22c55e","#ef4444"],borderWidth:0}]},
    options:{cutout:"75%",plugins:{legend:{position:"bottom"}}}
});

</script>
{% endif %}
{% endif %}

</body>
</html>